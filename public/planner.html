<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="UTF-8" />
  <title>æ—…è¡Œæ¸…å•</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="styles.css" />
  <script>
    window._AMapSecurityConfig = {
      securityJsCode: "5fd8a936c191f539f49b6abf555b7f60",
    };
  </script>
  <script src="https://webapi.amap.com/loader.js"></script>
  <style>
    /* Global Layout Fixes for SPA Feel */
    body {
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden; /* Prevent body scroll, handle inside slides */
    }
    .site-header {
      flex-shrink: 0;
      z-index: 1000;
    }

    /* Slider Styles */
    .view-wrapper {
      flex: 1; /* Fill remaining height */
      overflow: hidden;
      width: 100%;
      position: relative;
      margin: 0 !important; /* Override .container */
      padding: 0 !important; /* Override .container */
      max-width: none !important; /* Override .container */
    }
    .view-slider {
      display: flex;
      width: 200%;
      height: 100%;
      transition: transform 0.5s cubic-bezier(0.25, 1, 0.5, 1);
    }
    .view-slide {
      width: 50%;
      height: 100%;
      flex-shrink: 0;
      position: relative;
      overflow: hidden; /* Contain scrolls */
      box-sizing: border-box;
    }
    
    /* Block View Layout Overrides */
    #block-view.layout-main {
      display: flex;
      padding: 1rem;
      gap: 1.5rem;
      background-color: #f4f5f7;
    }
    
    /* Sidebar (Taskbar) */
    #block-view .main-column {
      position: relative !important; /* Override fixed from styles.css */
      top: auto; left: auto; bottom: auto;
      width: 320px;
      height: 100%;
      margin: 0;
      overflow-y: auto; /* Internal scrolling */
      display: flex;
      flex-direction: column;
      padding-bottom: 2rem;
    }
    
    /* Main Content (Plan List) */
    #block-view .side-column {
      margin-left: 0 !important; /* Override styles.css */
      flex: 1;
      height: 100%;
      overflow-y: auto; /* Internal scrolling */
      padding-bottom: 2rem;
      width: auto;
    }
    
    /* Map Styles */
    .map-container {
      position: relative;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      padding: 1.5rem; /* Leave background visible */
      box-sizing: border-box;
    }
    #map-container {
      flex: 1;
      width: 100%;
      background: white;
      box-shadow: 0 8px 24px rgba(0,0,0,0.08); /* Soft shadow */
      border-radius: 16px; /* Soft rounded corners */
      overflow: hidden;
    }
    .controls {
      position: absolute;
      top: 2.5rem; /* padding + offset */
      right: 2.5rem; /* padding + offset */
      z-index: 150;
      margin: 0;
      background: rgba(255,255,255,0.95);
      padding: 5px;
      border-radius: 6px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .day-selector select {
      padding: 5px 10px;
      font-size: 1rem;
      border: 1px solid #ddd;
      border-radius: 4px;
      background: white;
    }
    
    /* Custom Marker Styles */
    .amap-marker-content { white-space: nowrap; }
    .custom-marker { display: flex; flex-direction: column; align-items: center; }
    .marker-bubble {
        background: white;
        border: 2px solid #333;
        border-radius: 20px;
        padding: 5px 10px;
        box-shadow: 2px 2px 5px rgba(0,0,0,0.2);
        display: flex;
        align-items: center;
        gap: 5px;
        font-family: 'Comic Sans MS', 'YouYuan', sans-serif;
        transform: translateY(-5px);
    }
    .marker-index {
        background: #FF9800;
        color: white;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
    }
    .marker-name { font-weight: bold; color: #333; font-size: 14px; }
    .marker-pin {
        width: 0; height: 0;
        border-left: 8px solid transparent;
        border-right: 8px solid transparent;
        border-top: 10px solid #333;
    }
    .type-food .marker-index { background-color: #FF5722; }
    .type-place .marker-index { background-color: #4CAF50; }
    .type-stay .marker-index { background-color: #2196F3; }
  </style>
</head>
<body>
  <header class="site-header">
    <div style="display: flex; align-items: center; gap: 2rem;">
        <div style="display: flex; align-items: center;">
            <a href="index.html" style="color: white; text-decoration: none; margin-right: 1rem; font-size: 1.5rem;">&larr;</a>
            <h1 id="plan-title">æ—…è¡Œæ¸…å•</h1>
        </div>
        
        <div class="mode-switcher">
            <a href="javascript:void(0)" id="mode-block-btn" class="mode-btn active" onclick="switchMode('block')">ç§¯æœ¨æ¨¡å¼</a>
            <a href="javascript:void(0)" id="mode-map-btn" class="mode-btn" onclick="switchMode('map')">åœ°å›¾æ¨¡å¼</a>
        </div>
    </div>
  </header>

  <main class="view-wrapper">
    <div class="view-slider" id="view-slider">
        <!-- Block View -->
        <div class="view-slide layout-main" id="block-view">
            <section class="main-column">
              <h2>ä»»åŠ¡æ </h2>
              <div id="wish-list" class="card-list"></div>
        
              <section>
                <button id="clear-all" class="btn btn-secondary">æ¸…ç©ºå…¨éƒ¨æ„¿æœ›ï¼ˆæœ¬åœ°ï¼‰</button>
              </section>
            </section>
        
            <aside class="side-column">
              <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                  <h2 style="margin: 0;">è®¡åˆ’åˆ—è¡¨</h2>
                  <div style="display: flex; gap: 10px;">
                    <button onclick="HKWL.autoGenerateTransports()" class="btn btn-secondary" style="font-size: 0.9rem; padding: 0.3rem 0.8rem; background-color: #28a745; color: white; border: none;">âœ¨ æ™ºèƒ½äº¤é€š</button>
                  </div>
              </div>
              <div id="plan-days" class="plan-days"></div>
              <div id="plan-list" class="plan-list"></div>
              <p class="plan-hint">å°†å·¦ä¾§çš„æ—…è¡Œé¡¹ç›®æ‹–åŠ¨åˆ°æ­¤å¤„ï¼ŒæŒ‰å¤©ç»„æˆä½ çš„è®¡åˆ’åˆ—è¡¨ã€‚</p>
            </aside>
        </div>

        <!-- Map View -->
        <div class="view-slide" id="map-view">
            <div class="map-container">
                <div class="controls">
                  <div class="day-selector">
                    <select id="day-select">
                      <option value="all">å…¨éƒ¨è¡Œç¨‹</option>
                    </select>
                  </div>
                </div>
                <div id="map-container"></div>
            </div>
        </div>
    </div>
  </main>

  <div class="floating-add-wrapper">
    <div class="floating-add-buttons">
      <button id="add-note-btn" type="button" class="btn btn-secondary floating-note-btn">æ·»åŠ æ‰¹æ³¨</button>
      <button id="add-menu-toggle" type="button" class="btn btn-primary floating-add-btn">æ·»åŠ é¡¹ç›®</button>
    </div>
    <div id="add-menu" class="add-menu">
      <a href="manage.html?type=food" class="btn btn-primary add-menu-item add-menu-item-food">
        <span class="add-menu-icon">+</span>
        <span class="add-menu-type-label">ç¾é£Ÿ</span>
        <span class="add-menu-type-icon add-menu-type-icon-food">ğŸ½</span>
      </a>
      <a href="manage.html?type=place" class="btn btn-primary add-menu-item add-menu-item-place">
        <span class="add-menu-icon">+</span>
        <span class="add-menu-type-label">æ™¯ç‚¹</span>
        <span class="add-menu-type-icon add-menu-type-icon-place">ğŸ</span>
      </a>
      <a href="manage.html?type=stay" class="btn btn-primary add-menu-item add-menu-item-stay">
        <span class="add-menu-icon">+</span>
        <span class="add-menu-type-label">ä½å®¿</span>
        <span class="add-menu-type-icon add-menu-type-icon-stay">
          <svg viewBox="0 0 16 16" aria-hidden="true">
            <path
              fill="currentColor"
              d="M7.293 1.5a1 1 0 0 1 1.414 0l6 6A1 1 0 0 1 14.293 9H13.5v5.5a1 1 0 0 1-1 1h-3v-4h-3v4h-3a1 1 0 0 1-1-1V9H1.707a1 1 0 0 1-.707-1.707l6-6Z"
            />
          </svg>
        </span>
      </a>
      <a href="manage.html?type=transport" class="btn btn-primary add-menu-item add-menu-item-transport">
        <span class="add-menu-icon">+</span>
        <span class="add-menu-type-label">äº¤é€š</span>
        <span class="add-menu-type-icon add-menu-type-icon-transport">
          <svg viewBox="0 0 16 16" aria-hidden="true">
            <path
              fill="currentColor"
              d="M3 1.5A1.5 1.5 0 0 1 4.5 0h7A1.5 1.5 0 0 1 13 1.5V9a3 3 0 0 1-3 3h-.5l1.75 2.5a.75.75 0 1 1-1.2.9L8 12.5l-2.05 2.9a.75.75 0 1 1-1.2-.9L6.5 12H6a3 3 0 0 1-3-3V1.5ZM4.5 1a.5.5 0 0 0-.5.5V4h8V1.5a.5.5 0 0 0-.5-.5h-7ZM12 5.5H4v3A1.5 1.5 0 0 0 5.5 10h5A1.5 1.5 0 0 0 12 8.5v-3ZM6 6.5h1.5v2H6v-2Zm2.5 0H10v2H8.5v-2Z"
            />
          </svg>
        </span>
      </a>
    </div>
  </div>

  <script src="auth-manager.js"></script>
  <script src="main.js?v=10"></script>
  <script>
    let currentMode = 'block';
    let mapInitialized = false;
    let map = null;
    let mapState = { days: [] };
    let mapAllItems = [];

    function switchMode(mode) {
        if (currentMode === mode) return;
        currentMode = mode;
        
        const slider = document.getElementById('view-slider');
        const blockBtn = document.getElementById('mode-block-btn');
        const mapBtn = document.getElementById('mode-map-btn');
        
        if (mode === 'map') {
            slider.style.transform = 'translateX(-50%)';
            blockBtn.classList.remove('active');
            mapBtn.classList.add('active');
            
            // Hide floating buttons in map mode
            document.querySelector('.floating-add-wrapper').style.display = 'none';

            if (!mapInitialized) {
                initMapLogic();
                mapInitialized = true;
            } else {
                 if (map) {
                     setTimeout(() => {
                         map.resize(); 
                         const daySelect = document.getElementById('day-select');
                         // Reload data to ensure sync with block mode changes
                         mapState = HKWL.loadPlanState();
                         mapAllItems = HKWL.loadWishlist();
                         updateDaySelector();
                         renderMap(daySelect.value);
                     }, 500);
                 }
            }
        } else {
            slider.style.transform = 'translateX(0)';
            mapBtn.classList.remove('active');
            blockBtn.classList.add('active');
            // Show floating buttons in block mode
            document.querySelector('.floating-add-wrapper').style.display = 'block';
        }
    }

    // --- Map Logic ---

    async function initMapLogic() {
        mapState = HKWL.loadPlanState();
        mapAllItems = HKWL.loadWishlist();
        
        // Setup Day Selector
        updateDaySelector();
        
        const daySelect = document.getElementById('day-select');
        daySelect.addEventListener('change', () => {
            renderMap(daySelect.value);
        });

        await initMap();
    }

    function updateDaySelector() {
        const daySelect = document.getElementById('day-select');
        // Keep first option (All)
        while (daySelect.options.length > 1) {
            daySelect.remove(1);
        }
        
        mapState.days.forEach((_, index) => {
            const option = document.createElement('option');
            option.value = index + 1;
            option.textContent = `ç¬¬ ${index + 1} å¤©`;
            daySelect.appendChild(option);
        });
    }

    async function initMap() {
        try {
            const AMap = await AMapLoader.load({
                key: "8040299dec271ec2928477f709015d3d",
                version: "2.0",
                plugins: ["AMap.Scale", "AMap.ToolBar", "AMap.ControlBar", "AMap.Driving", "AMap.Walking", "AMap.Transfer"]
            });
            
            map = new AMap.Map("map-container", {
                zoom: 4,
                center: [105.0, 35.0], 
                viewMode: '3D', 
                features: ['bg', 'road', 'building', 'point']
            });
            
            map.addControl(new AMap.Scale());
            map.addControl(new AMap.ToolBar({ position: 'RB' }));
            
            const daySelect = document.getElementById('day-select');
            renderMap(daySelect.value);
            
        } catch (e) {
            console.error(e);
            document.getElementById('map-container').innerHTML = 
                '<div style="display:flex;justify-content:center;align-items:center;height:100%;color:#666;">åœ°å›¾åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè®¾ç½®</div>';
        }
    }

    function getItemsForDay(dayIndex) { 
        if (!mapState.days[dayIndex]) return [];
        return mapState.days[dayIndex].map(id => mapAllItems.find(item => item.id === id)).filter(Boolean);
    }

    function getAllItemsOrdered() {
        let list = [];
        mapState.days.forEach(dayIds => {
           list = list.concat(dayIds.map(id => mapAllItems.find(item => item.id === id)).filter(Boolean));
        });
        return list;
    }

    async function renderMap(dayMode) {
        if (!map) return;
        map.clearMap();

        let items = [];
        if (dayMode === 'all') {
            items = getAllItemsOrdered();
        } else {
            const dayIndex = parseInt(dayMode) - 1;
            items = getItemsForDay(dayIndex);
        }

        if (items.length === 0) return;

        let seqIndex = 1;
        let lastNode = null;

        for (let i = 0; i < items.length; i++) {
            const item = items[i];
            
            if (item.type !== 'transport' && item.coords && item.coords.lng && item.coords.lat) {
                const position = new AMap.LngLat(item.coords.lng, item.coords.lat);
                
                let typeClass = "";
                if (item.type === 'food') typeClass = "type-food";
                if (item.type === 'place') typeClass = "type-place";
                if (item.type === 'stay') typeClass = "type-stay";
                
                const content = `
                    <div class="custom-marker ${typeClass}">
                        <div class="marker-bubble">
                            <span class="marker-index">${seqIndex}</span>
                            <span class="marker-name">${item.name}</span>
                        </div>
                        <div class="marker-pin"></div>
                    </div>
                `;
                
                new AMap.Marker({
                    position: position,
                    content: content,
                    offset: new AMap.Pixel(-15, -35),
                    map: map,
                    anchor: 'bottom-center',
                    zIndex: 100
                });
                
                seqIndex++;

                if (lastNode) {
                    const startPos = lastNode.position;
                    const endPos = position;
                    let transportItem = null;
                    // Find transport between nodes
                     for (let j = lastNode.originalIndex + 1; j < i; j++) {
                        if (items[j].type === 'transport') {
                            transportItem = items[j];
                            break; 
                        }
                    }
                    await drawRoute(startPos, endPos, transportItem);
                }
                lastNode = { position, originalIndex: i };
            }
        }
        map.setFitView(null, false, [50, 50, 50, 50]);
    }

    async function drawRoute(start, end, transportItem) {
        if (!map) return;
        let mode = 'driving';
        if (transportItem) {
            if (transportItem.name.includes('æ­¥è¡Œ') || transportItem.name.includes('ğŸš¶')) mode = 'walking';
            else if (transportItem.name.includes('åœ°é“') || transportItem.name.includes('å…¬äº¤') || transportItem.name.includes('ğŸš‡') || transportItem.name.includes('bus')) mode = 'transit';
        }
        
        try {
            if (mode === 'walking') await drawWalkingRoute(start, end);
            else if (mode === 'transit') await drawDrivingRoute(start, end, "#9C27B0");
            else await drawDrivingRoute(start, end, "#2196F3");
        } catch (e) {
            new AMap.Polyline({
                path: [start, end],
                strokeColor: "#999",
                strokeWeight: 4,
                strokeStyle: "dashed",
                map: map
            });
        }
    }
    
    function drawWalkingRoute(start, end) {
        return new Promise((resolve) => {
            const walking = new AMap.Walking();
            walking.search(start, end, (status, result) => {
                if (status === 'complete' && result.routes && result.routes.length) {
                    const path = [];
                    result.routes[0].steps.forEach(step => path.push(...step.path));
                    new AMap.Polyline({
                        path: path,
                        strokeColor: "#4CAF50",
                        strokeWeight: 6,
                        strokeOpacity: 0.9,
                        showDir: true,
                        map: map
                    });
                    resolve();
                } else {
                    new AMap.Polyline({ path: [start, end], strokeColor: "#4CAF50", strokeWeight: 4, strokeStyle: "dashed", map: map });
                    resolve();
                }
            });
        });
    }

    function drawDrivingRoute(start, end, color) {
        return new Promise((resolve) => {
            const driving = new AMap.Driving({ policy: AMap.DrivingPolicy.LEAST_TIME });
            driving.search(start, end, (status, result) => {
                if (status === 'complete' && result.routes && result.routes.length) {
                    const path = [];
                    result.routes[0].steps.forEach(step => path.push(...step.path));
                    new AMap.Polyline({
                        path: path,
                        strokeColor: color,
                        strokeWeight: 6,
                        strokeOpacity: 0.9,
                        showDir: true,
                        map: map
                    });
                    resolve();
                } else {
                    new AMap.Polyline({ path: [start, end], strokeColor: color, strokeWeight: 4, strokeStyle: "dashed", map: map });
                    resolve();
                }
            });
        });
    }

    document.addEventListener("DOMContentLoaded", function () {
      const urlParams = new URLSearchParams(window.location.search);
      const planId = urlParams.get('id');
      
      HKWL.setCurrentPlan(planId);
      HKWL.renderWishlistPage();

      if (planId) {
          document.querySelectorAll('a[href^="manage.html"]').forEach(a => {
              if (a.href.includes('?')) {
                  a.href += `&planId=${planId}`;
              } else {
                  a.href += `?planId=${planId}`;
              }
          });
      }
    });
  </script>
</body>
</html>
